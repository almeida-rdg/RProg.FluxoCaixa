version: '3.9'

networks:
  proxy-net:
    driver: bridge
  lancamentos-net:
    driver: bridge
  consolidado-net:
    driver: bridge
  rabbitmq-net:
    driver: bridge
  db-net:
    driver: bridge
  worker-net:
    driver: bridge

services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: fluxo-sqlserver
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=Your_password123
      - MSSQL_PID=Express
    ports:
      - "1433:1433"
    networks:
      - db-net
      - lancamentos-net
      - consolidado-net
      - worker-net
    volumes:
      - ./lancamentos/scripts/criar-banco.sql:/docker-entrypoint-initdb.d/01-criar-banco.sql
      - ./worker/scripts/criar-banco-consolidado.sql:/docker-entrypoint-initdb.d/02-criar-banco-consolidado.sql
    command: >
      /bin/bash -c "
      /opt/mssql/bin/sqlservr &

      until /opt/mssql-tools18/bin/sqlcmd -l 1 -C -S localhost -U sa -P 'Your_password123' -Q 'SELECT 1' &> /dev/null; do
        >&2 echo '>>>>>>>>>> SQL Server is unavailable - sleeping <<<<<<<<<<';
        sleep 5;
      done;
      echo '>>>>>>>>>> SQL Server is ready - executing init scripts <<<<<<<<<<';
      /opt/mssql-tools18/bin/sqlcmd -l 5 -C -S localhost -U sa -P 'Your_password123' -d master -i /docker-entrypoint-initdb.d/01-criar-banco.sql;
      /opt/mssql-tools18/bin/sqlcmd -l 5 -C -S localhost -U sa -P 'Your_password123' -d master -i /docker-entrypoint-initdb.d/02-criar-banco-consolidado.sql;
      
      sleep infinity;"

  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: fluxo-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - rabbitmq-net
      - lancamentos-net
      - consolidado-net
      - worker-net
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
  lancamentos-api:
    build:
      context: ./lancamentos
      dockerfile: Dockerfile
    container_name: fluxo-lancamentos
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=FluxoCaixa;User=sa;Password=Your_password123;Trust Server Certificate=True;
      - RabbitMQ__HostName=rabbitmq
      - RabbitMQ__QueueName=lancamento.geral
    depends_on:
      - sqlserver
      - rabbitmq
    ports:
      - "8080:8080"
    networks:
      - lancamentos-net
      - db-net
      - rabbitmq-net
      - proxy-net  consolidado-api:
    build:
      context: ./consolidado
      dockerfile: Dockerfile
    container_name: fluxo-consolidado
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=RProg_FluxoCaixa_Consolidado;User=sa;Password=Your_password123;Trust Server Certificate=True;
      - Serilog__MinimumLevel__Default=Information
      - ASPNETCORE_URLS=http://+:8080
    depends_on:
      - sqlserver
    ports:
      - "8081:8080"
    networks:
      - consolidado-net
      - db-net
    volumes:
      - consolidado_logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
  #     - proxy-net

  worker:
    build:
      context: .
      dockerfile: ./worker/Dockerfile
    container_name: fluxo-worker
    environment:
      - DOTNET_ENVIRONMENT=Production
      - ConnectionStrings__DefaultConnection=Server=sqlserver,1433;Database=RProg_FluxoCaixa_Consolidado;User Id=sa;Password=Your_password123;TrustServerCertificate=true;MultipleActiveResultSets=true
      - RabbitMQ__HostName=rabbitmq
      - RabbitMQ__Port=5672
      - RabbitMQ__UserName=guest
      - RabbitMQ__Password=guest
      - RabbitMQ__VirtualHost=/
      - RabbitMQ__PrefixoFila=lancamento
      - RabbitMQ__Filas__0=lancamento.geral
      - RabbitMQ__Filas__1=lancamento.prioritaria
      - Serilog__MinimumLevel__Default=Information
    depends_on:
      - sqlserver
      - rabbitmq
    networks:
      - worker-net
      - db-net
      - rabbitmq-net
    volumes:
      - worker_logs:/app/logs
    restart: unless-stopped
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
  #     - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=FluxoCaixa;User=sa;Password=Your_password123;
  #     - RabbitMQ__HostName=rabbitmq
  #     - RabbitMQ__QueueName=lancamentos
  #   depends_on:
  #     - sqlserver
  #     - rabbitmq
  #   networks:
  #     - db-net
  #     - rabbitmq-net
  #     - consolidado-net
  #     - lancamentos-net

  # proxy:
  #   build:
  #     context: ./proxy/RProg.FluxoCaixa.Proxy
  #     dockerfile: Dockerfile
  #   container_name: fluxo-proxy
  #   environment:
  #     - ASPNETCORE_ENVIRONMENT=Development
  #   ports:
  #     - "8080:80"
  #     - "8443:443"
  #   depends_on:
  #     - lancamentos-api
  #     - consolidado-api
  #   networks:
  #     - proxy-net

# Restrições de acesso:
# - Apenas o serviço proxy expõe portas externas.
# - Todas as comunicações internas são feitas por redes privadas específicas.
# - O worker processa mensagens em segundo plano sem exposição externa.

volumes:
  rabbitmq_data:
    driver: local
  worker_logs:
    driver: local
  consolidado_logs:
    driver: local